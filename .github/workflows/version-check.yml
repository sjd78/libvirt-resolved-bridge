name: Version Check

on:
  pull_request:
    branches: [ main ]

jobs:
  check-version:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Get changed files
      id: changed-files
      uses: tj-actions/changed-files@v45
      with:
        files: |
          src/**
          go.mod
          go.sum
          Makefile
          libvirt-resolved-bridge.service

    - name: Check if version was updated
      if: steps.changed-files.outputs.any_changed == 'true'
      run: |
        # Check if Version or Release line was modified in the spec file
        if git diff origin/main --name-only | grep -q "libvirt-resolved-bridge.spec"; then
          # Spec file was modified, check if Version or Release changed
          if git diff origin/main -- libvirt-resolved-bridge.spec | grep -qE '^\+Version:|^\+Release:'; then
            cat >> "$GITHUB_STEP_SUMMARY" <<EOF
            ## ✅ Version Check Passed
            Version or Release was updated in the spec file.

            ### Changed RPM-relevant files:
            \`\`\`
            ${ steps.changed-files.outputs.all_changed_files }
            \`\`\`
            EOF
            exit 0
          else
            cat >> "$GITHUB_STEP_SUMMARY" <<EOF
            ## ⚠️ Version Check Failed
            Spec file was modified but **Version** or **Release** was not changed.

            ### Changed RPM-relevant files:
            \`\`\`
            ${ steps.changed-files.outputs.all_changed_files }
            \`\`\`

            ### How to fix:
            - **Bump Version** for new features or breaking changes
            - **Bump Release** for bug fixes or minor changes
            EOF
            exit 1
          fi
        else
          cat >> "$GITHUB_STEP_SUMMARY" <<EOF
          ## ❌ Version Check Failed
          RPM-relevant files were changed but the spec file **Version/Release** was not updated.

          ### Changed files that require a version bump:
          \`\`\`
          ${ steps.changed-files.outputs.all_changed_files }
          \`\`\`

          ### How to fix:
          Update \`libvirt-resolved-bridge.spec\`:
          - **Bump Version** for new features or breaking changes
          - **Bump Release** for bug fixes or minor changes
          EOF
          exit 1
        fi

    - name: No version check needed
      if: steps.changed-files.outputs.any_changed != 'true'
      run: |
        cat >> "$GITHUB_STEP_SUMMARY" <<EOF
        ## ✅ Version Check Skipped
        No RPM-relevant files were changed in this PR.
        EOF

